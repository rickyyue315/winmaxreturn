# 退貨建議分析系統 - 使用說明

## 系統概述
這是一個基於 Streamlit 開發的網頁應用程序，專門用於分析庫存數據並生成退貨建議。系統將退貨目標設置為站點 D001。

## 主要功能

### 1. 數據上傳與預處理
- 支持 Excel (.xlsx) 文件上傳
- 自動數據類型轉換和驗證
- 異常值檢測和修正
- 缺失值處理

### 2. 退貨規則引擎
#### 優先級 1 - ND 類型退倉
- **條件**: RP Type = "ND"
- **退貨數量**: 全部現有庫存 (SaSa Net Stock)
- **目標**: D001

#### 優先級 2 - RF 類型過剩退倉
- **條件**: 
  - RP Type = "RF"
  - 庫存充足: SaSa Net Stock + Pending Received > Safety Stock
  - 非高銷量店鋪: 該店鋪銷量不在該商品的前 20%
- **退貨數量計算**: 
  - 基礎數量 = SaSa Net Stock + Pending Received - Safety Stock
  - 最終數量 ≤ min(基礎數量, SaSa Net Stock - Safety Stock * 0.2)
  - 最少 2 件
- **目標**: D001

### 3. 有效銷量計算
- 優先使用 Last Month Sold Qty
- 若為 0 或缺失，則使用 MTD Sold Qty

### 4. 輸出格式
生成包含兩個工作表的 Excel 文件：
1. **退貨建議**: 詳細的退貨記錄
2. **統計摘要**: KPI 和分析圖表

## 使用步驟

### 1. 啟動應用程序
```bash
streamlit run app.py
```

### 2. 訪問網頁界面
打開瀏覽器，訪問 `http://localhost:8501`

### 3. 上傳數據文件
- 點擊文件上傳按鈕選擇 Excel (.xlsx) 文件

### 4. 選擇分析類型 (新增)
在分析處理部分，用戶可以選擇要分析的退貨類型：
- **ND 和 RF 都計算** (默認)：完整分析所有類型
- **只計算 ND 類型**：僅分析需要完全清倉的商品
- **只計算 RF 類型**：僅分析庫存過剩的商品

### 5. 數據預覽
系統會自動顯示：
- 數據基本統計信息
- 前 5 行數據預覽
- 關鍵欄位分布

### 6. 生成退貨建議
點擊 "生成退貨建議" 按鈕，系統將：
- 處理和驗證數據
- 應用退貨規則
- 生成建議表
- 進行質量檢查

### 7. 查看結果
- 查看退貨建議表
- 分析統計圖表
- 檢查質量驗證結果

### 8. 下載報告
點擊下載按鈕獲取 Excel 格式的完整報告

## 必需的 Excel 欄位

| 欄位名稱 | 數據類型 | 說明 |
|---------|---------|------|
| Article | 字符串 | 產品編號 (12位) |
| Article Description | 字符串 | 產品描述 |
| OM | 字符串 | 營運管理單位 |
| RP Type | 字符串 | 轉出類型 (ND/RF) |
| Site | 字符串 | 店鋪編號 |
| SaSa Net Stock | 整數 | 現有庫存 |
| Pending Received | 整數 | 在途訂單 |
| Safety Stock | 整數 | 安全庫存 |
| Last Month Sold Qty | 整數 | 上月銷量 |
| MTD Sold Qty | 整數 | 本月至今銷量 |

## 質量檢查項目

1. ✅ Article 和 OM 一致性檢查
2. ✅ Transfer Qty 為正整數
3. ✅ Transfer Qty 不超過原庫存
4. ✅ Article 格式正確 (12位字符串)
5. ✅ RF 類型退貨後庫存安全性檢查

## 技術要求

### 環境依賴
- Python 3.8+
- Streamlit 1.49+
- Pandas 2.3+
- OpenPyXL 3.1+
- NumPy 2.2+

### 安裝命令
```bash
pip install streamlit pandas openpyxl numpy
```

## 文件結構

```
/workspace/
├── app.py                    # 主應用程序
├── user_input_files/
│   └── ELE_15Sep2025.XLSX   # 默認測試文件
└── README.md                # 本說明文件
```

## 注意事項

1. **數據安全**: 所有處理均在本地環境進行，不會上傳到外部服務器
2. **性能**: 建議單次處理的數據量不超過 10,000 行
3. **格式**: 僅支持 .xlsx 格式的 Excel 文件
4. **編碼**: 支持中英文混合內容

## 故障排除

### 常見問題

1. **文件讀取失敗**
   - 檢查文件格式是否為 .xlsx
   - 確保文件沒有密碼保護
   - 驗證必需欄位是否存在

2. **無退貨建議生成**
   - 檢查 RP Type 值是否正確 (ND/RF)
   - 驗證庫存數據是否為正數
   - 確認安全庫存設置合理

3. **下載失敗**
   - 檢查瀏覽器下載設置
   - 確保有足夠的磁盤空間

## 聯絡支援

如遇到技術問題，請提供：
- 錯誤信息截圖
- 數據文件樣本（脫敏後）
- 操作步驟描述

---

**版本**: 1.0.0  
**更新日期**: 2025-09-15  
**開發者**: MiniMax Agent
