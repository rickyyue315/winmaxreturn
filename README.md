# 退貨建議分析系統 - 使用說明

## 系統概述
這是一個基於 Streamlit 開發的網頁應用程序，專門用於分析庫存數據並生成退貨建議。系統將退貨目標設置為站點 D001。

## 主要功能

### 1. 數據上傳與預處理
- 支持 Excel (.xlsx) 文件上傳
- 自動數據類型轉換和驗證
- 異常值檢測和修正
- 缺失值處理

### 2. 退貨規則引擎
#### 優先級 1 - ND 類型退倉
- **條件**: RP Type = "ND" 且現有庫存 > 0
- **退貨數量**: 全部現有庫存 (SaSa Net Stock)
- **目標**: D001
- **特別提示**: 如有銷售記錄，系統會提示 Buyer 需要留意是否需轉成 RF 及設定 Safety Stock

#### 優先級 2 - RF 類型過剩退倉
- **條件**: 
  - RP Type = "RF"
  - 庫存充足: SaSa Net Stock + Pending Received > Safety Stock
  - 非高銷量店鋪: 該店鋪銷量不在該商品的前 20%
- **退貨數量計算**: 
  - 潛在退貨量 = SaSa Net Stock + Pending Received - Safety Stock
  - **若上月銷售量/MTD銷售量 其中一個月 > Safety Qty**：退貨後淨餘數量需高於 Safety Qty 的 25% 且至少 +2 件
  - **若上月銷售量/MTD銷售量 同樣地 ≤ Safety Qty**：退貨後淨餘數量只需高於 Safety Qty 1 件
  - 最終退貨量 = min(潛在退貨量, 總可用庫存 - 最小保留量)
  - 最少 2 件
- **目標**: D001

### 3. 計算類型選擇 (v1.1.0 新增)
用戶可以根據業務需求選擇分析範圍：
- **ND 和 RF 都計算** (默認)：完整分析所有類型
- **只計算 ND 類型**：僅分析需要完全清倉的商品
- **只計算 RF 類型**：僅分析庫存過剩的商品

### 4. 有效銷量計算
- 優先使用 Last Month Sold Qty
- 若為 0 或缺失，則使用 MTD Sold Qty

### 5. 輸出格式
生成包含兩個工作表的 Excel 文件：
1. **退貨建議**: 詳細的退貨記錄
2. **統計摘要**: KPI 和分析圖表

## 使用步驟

### 1. 啟動應用程序
```bash
streamlit run app.py
```

### 2. 訪問網頁界面
打開瀏覽器，訪問 `http://localhost:8501`

### 3. 上傳數據文件
- 點擊文件上傳按鈕選擇 Excel (.xlsx) 文件

### 4. 數據預覽
系統會自動顯示：
- 數據基本統計信息
- 前 5 行數據預覽
- 關鍵欄位分布

### 5. 選擇計算類型
在「分析設置」部分，用戶可以選擇要分析的退貨類型：
- **ND 和 RF 都計算** (默認)：完整分析所有類型
- **只計算 ND 類型**：僅分析需要完全清倉的商品
- **只計算 RF 類型**：僅分析庫存過剩的商品

### 6. 生成退貨建議
點擊 "生成退貨建議" 按鈕，系統將：
- 處理和驗證數據
- 應用退貨規則
- 生成建議表
- 進行質量檢查

### 7. 查看結果
- 查看退貨建議表
- 分析統計圖表
- 檢查質量驗證結果

### 8. 下載報告
點擊下載按鈕獲取 Excel 格式的完整報告

## 必需的 Excel 欄位

| 欄位名稱 | 數據類型 | 說明 |
|---------|---------|------|
| Product Hierarchy | 字符串 | 產品層級 |
| Article | 字符串 | 產品編號 (12位) |
| Article Description | 字符串 | 產品描述 |
| OM | 字符串 | 營運管理單位 |
| RP Type | 字符串 | 轉出類型 (ND/RF) |
| Site | 字符串 | 店鋪編號 |
| SaSa Net Stock | 整數 | 現有庫存 |
| Pending Received | 整數 | 在途訂單 |
| Safety Stock | 整數 | 安全庫存 |
| Last Month Sold Qty | 整數 | 上月銷量 |
| MTD Sold Qty | 整數 | 本月至今銷量 |

## 質量檢查項目

1. ✅ Article 和 OM 一致性檢查
2. ✅ Transfer Qty 為正整數
3. ✅ Transfer Qty 不超過原庫存
4. ✅ Article 格式正確 (12位字符串)
5. ✅ RF 類型退貨後庫存安全性檢查

## 技術要求

### 環境依賴
- Python 3.8+
- Streamlit 1.49+
- Pandas 2.3+
- OpenPyXL 3.1+
- NumPy 2.2+

### 安裝命令
```bash
pip install streamlit pandas openpyxl numpy
```

## 文件結構

```
/workspace/
├── app.py                    # 主應用程序
├── test_app.py              # 功能測試腳本
├── requirements.txt         # 依賴包列表
├── start.sh                 # 快速啟動腳本
├── README.md               # 本說明文件
├── PROJECT_SUMMARY.md      # 項目總結
├── FEATURE_UPDATE_v1.1.0.md  # v1.1.0 功能更新說明
├── UPDATE_v1.1.1.md         # v1.1.1 更新日誌
└── UPDATE_v1.1.2.md         # v1.1.2 更新日誌
```

## 版本歷史

### v1.1.2 (2025-09-17)
- 🎨 新增底部開發者水印："由 Ricky 開發 | © 2025"
- ✅ 界面優化，提升品牌識別度

### v1.1.1 (2025-09-15)
- 🔄 移除默認文件功能
- ✅ 簡化用戶界面，只保留文件上傳功能
- ✅ 移除雙欄布局，改為單一的文件上傳介面

### v1.1.0 (2025-09-15)
- 🎉 新增計算類型選擇功能
- ✅ 支持三種分析模式：ND 和 RF 都計算、只計算 ND 類型、只計算 RF 類型
- ✅ 提升用戶使用靈活性

### v1.0.0 (2025-09-15)
- 🚀 首次發布
- ✅ 基礎退貨建議分析功能
- ✅ Streamlit 網頁應用
- ✅ Excel 報告生成

## 注意事項

1. **數據安全**: 所有處理均在本地環境進行，不會上傳到外部服務器
2. **性能**: 建議單次處理的數據量不超過 10,000 行
3. **格式**: 僅支持 .xlsx 格式的 Excel 文件
4. **編碼**: 支持中英文混合內容

## 故障排除

### 常見問題

1. **文件讀取失敗**
   - 檢查文件格式是否為 .xlsx
   - 確保文件沒有密碼保護
   - 驗證必需欄位是否存在

2. **無退貨建議生成**
   - 檢查 RP Type 值是否正確 (ND/RF)
   - 驗證庫存數據是否為正數
   - 確認安全庫存設置合理

3. **下載失敗**
   - 檢查瀏覽器下載設置
   - 確保有足夠的磁盤空間

## 聯絡支援

如遇到技術問題，請提供：
- 錯誤信息截圖
- 數據文件樣本（脫敏後）
- 操作步驟描述

---

**版本**: 1.1.2  
**更新日期**: 2025-12-29  
**開發者**: Ricky
